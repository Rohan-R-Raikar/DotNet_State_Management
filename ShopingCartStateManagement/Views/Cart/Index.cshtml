@model IEnumerable<ShopingCartStateManagement.Models.CartItem>
@{
    ViewData["Title"] = "Shopping Cart";
}

<div class="alert alert-info mt-3">
    <strong>Live Users:</strong> <span id="totalUsers">0</span><br />
    <strong>Logged-in Users:</strong> <span id="loggedInUsers">0</span>
</div>


<div class="container mt-5">
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <h2 class="card-title text-center mb-4 text-primary fw-bold">
                <i class="bi bi-cart4 me-2"></i> @ViewData["Title"]
            </h2>
            
            <form asp-action="AddItem" method="post" class="row g-3 align-items-center mb-4">
                <input type="hidden" name="userId" value="@ViewBag.UserId" />
                <div class="col-md-8">
                    <select name="productId" class="form-select form-select-lg shadow-sm" required>
                        <option value="" disabled selected>Select a product</option>
                        @foreach (var product in ViewBag.Products)
                        {
                            <option value="@product.Id">@product.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4 d-grid">
                    <button type="submit" class="btn btn-success btn-lg shadow-sm">
                        <i class="bi bi-plus-circle me-2"></i>Add Item
                    </button>
                </div>
            </form>

            <div id="productsList" class="mb-4">
                <h5 class="text-secondary mb-2">Product Stock</h5>
                @foreach (var product in ViewBag.Products)
                {
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span>@product.Name</span>
                        <span id="stock-@product.Name">@product.Stock</span>
                    </div>
                }
            </div>

            <div id="cartContainer" class="mt-4">
                <h4 class="text-secondary mb-3 border-bottom pb-2">
                    <i class="bi bi-bag-check-fill me-2"></i>Your Cart Items
                </h4>

                <ul id="cartList" class="list-group list-group-flush">
                    @if (Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <span class="fw-bold text-dark">@item.ProductName</span>
                                    <span class="badge bg-info text-dark ms-2">Qty: @item.Quantity</span>
                                </div>

                                <form asp-action="RemoveItem" method="post" class="m-0">
                                    <input type="hidden" name="Id" value="@item.Id" />
                                    <input type="hidden" name="userId" value="@item.UserId" />
                                    <input type="hidden" name="productName" value="@item.ProductName" />
                                    <button type="submit"
                                            class="btn btn-outline-danger btn-sm px-3 py-2 rounded-pill shadow-sm d-flex align-items-center"
                                            onclick="return confirm('Are you sure you want to delete this item?');">
                                        <i class="bi bi-trash3 me-2"></i> Delete
                                    </button>
                                </form>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-center text-muted py-4">
                            <i class="bi bi-emoji-frown me-2"></i>Your cart is empty.
                        </li>
                    }
                </ul>
            </div>

            <hr class="my-4" />
            <p class="text-muted small mb-0">
                <b>User ID:</b> <span class="text-dark">@ViewBag.UserId</span>
            </p>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/cartHub")
        .build();

    connection.on("StockUpdated", function (data) {
        console.log("Stock updated:", data);

        if (data && data.productName && data.stock !== undefined) {
            const element = document.getElementById(`stock-${data.productName}`);
            if (element) {
                element.innerText = data.stock;
            }
        }
    });

        connection.on("UpdateUserCounts", function (data) {
        if (data) {
            document.getElementById("totalUsers").innerText = data.total;
            document.getElementById("loggedInUsers").innerText = data.loggedIn;
        }
    });


    connection.start()
        .then(() => console.log("Connected to CartHub"))
        .catch(err => console.error("SignalR connection failed:", err));
</script>
